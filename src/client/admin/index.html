<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Admin Panel - Dinosonic</title>
        <script src="/public/tailwindcss.min.js"></script>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

            @font-face {
                font-family: 'Dinofiles';
                src: url('/public/Dinofiles-font.ttf') format('truetype');
                font-weight: normal;
                font-style: normal;
            }

            @font-face {
                font-family: 'VT323';
                src: url('/public/VT323-Regular.ttf') format('truetype');
                font-weight: normal;
                font-style: normal;
            }

            body {
                font-family: 'VT323', monospace;
                background-color: #000;
                color: #fff;
            }

            .brand-title {
                font-family: 'Dinofiles', monospace;
            }

            .footer {
                color: #999;
                border-top: 1px solid #999;
            }

            .social-link {
                color: #999;
                transition: all 0.2s ease;
            }

            .social-link:hover {
                text-decoration: underline;
            }

            /* Button hover effects */
            .hover-effect {
                transition: all 0.2s ease-in-out;
            }

            .hover-effect:hover {
                transform: translateY(-2px);
                filter: brightness(120%);
                box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
            }

            /* Container spacing fix */
            .dashboard-container {
                margin-top: 0;
                margin-bottom: 0;
            }

            .dashboard-container + .dashboard-container {
                margin-top: 1.5rem;
            }
        </style>
        <script>
            async function fetchVersion() {
                try {
                    const response = await fetch('/api/version');
                    const data = await response.json();
                    document.getElementById('version').innerText = `Version ${data.version}`;
                } catch (error) {
                    console.error('Error fetching version:', error);
                }
            }
            window.onload = fetchVersion;
        </script>
    </head>

    <body class="bg-black min-h-screen flex flex-col">
        <!-- Banner with branding -->
        <div class="w-full py-6 px-4 mb-8">
            <div class="max-w-4xl mx-auto flex items-center justify-between">
                <div>
                    <h1 class="brand-title text-5xl mb-1">DINOSONIC</h1>
                    <p class="text-blue-300">
                        A fast, lightweight music streaming server built with Deno, inspired by Subsonic.
                    </p>
                </div>
                <div class="text-right">
                    <div class="text-xs text-blue-400 mb-1">ADMIN PANEL</div>
                    <div id="server-status" class="text-green-400">Server Online</div>
                </div>
            </div>
        </div>

        <div class="flex-grow flex flex-col items-center px-8">
            <h1 class="text-4xl mb-6">Admin Panel</h1>

            <!-- Login to Dino Music Button -->
            <div class="w-full max-w-2xl border border-white p-6 dashboard-container">
                <button id="dino-music-login" class="w-full bg-blue-600 p-2 uppercase hover-effect">
                    Login to Dino Music
                </button>
            </div>

            <!-- API Keys Management -->
            <div class="w-full max-w-2xl border border-white p-6 dashboard-container">
                <h2 class="text-2xl mb-4">API Keys</h2>
                <p class="text-sm mb-4">API keys allow you to authenticate without using your password. Keep them secure!</p>

                <!-- Create API Key -->
                <div class="mb-4">
                    <input id="api-key-name" type="text" placeholder="Key Name (optional)" class="w-full p-2 mb-2 bg-inherit border border-white">
                    <button id="create-api-key" class="w-full bg-green-700 p-2 uppercase hover-effect">
                        Create New API Key
                    </button>
                </div>

                <!-- API Keys List -->
                <div id="api-keys-list">
                    <h3 class="text-xl mb-2">Your API Keys</h3>
                    <ul id="api-keys-container" class="list-none"></ul>
                </div>

                <!-- New API Key Display Modal -->
                <div id="new-api-key-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
                    <div class="bg-black p-6 border border-white shadow-lg max-w-lg">
                        <h2 class="text-xl font-bold mb-4">API Key Created!</h2>
                        <p class="text-yellow-400 mb-2">⚠️ Save this key now - you won't be able to see it again!</p>
                        <div class="bg-gray-900 p-3 mb-4 border border-gray-600 break-all font-mono text-sm">
                            <span id="new-api-key-value"></span>
                        </div>
                        <button id="copy-api-key" class="w-full bg-blue-600 p-2 mb-2 hover-effect">Copy to Clipboard</button>
                        <button id="close-api-key-modal" class="w-full bg-white text-black p-2 hover-effect">Close</button>
                    </div>
                </div>
            </div>

            <!-- User Management (Visible to Admins Only) -->
            <div id="user-management" class="w-full max-w-2xl border border-white p-6 dashboard-container hidden">
                <h2 class="text-2xl mb-4">User Management</h2>

                <!-- Create User (Admin Only) -->
                <div id="admin-controls" class="mb-6 hidden">
                    <h3 class="text-xl mb-2">Create User</h3>
                    <input id="new-username" type="text" placeholder="Username" class="w-full p-2 mb-2 bg-inherit border border-white">
                    <input id="new-password" type="password" placeholder="Password" class="w-full p-2 mb-2 bg-inherit border border-white">
                    <button id="create-user" class="w-full bg-green-700 p-2 uppercase hover-effect">
                        Create User
                    </button>
                </div>

                <!-- Users List -->
                <ul id="users-container" class="list-none"></ul>
            </div>

            <!-- Scrobbling Settings -->
            <div class="w-full max-w-2xl border border-white p-6 dashboard-container">
                <h2 class="text-2xl mb-4">LastFM Scrobbling</h2>
                <p>Status: <span id="lastfm-text" class="text-red-500">Not Linked</span></p>
                <button id="lastfm-button" class="w-full bg-white text-black p-2 uppercase mt-4 hover-effect">
                    Link LastFM
                </button>
            </div>

            <div class="w-full max-w-2xl border border-white p-6 dashboard-container">
                <h2 class="text-2xl mb-4">ListenBrainz Scrobbling</h2>
                <p>Status: <span id="listenbrainz-text" class="text-red-500">Not Linked</span></p>

                <!-- This container will hold the input field and will be shown/hidden dynamically -->
                <div id="listenbrainz-input-container" class="hidden mt-4">
                    <p class="text-sm mb-2">
                        Get your user token from your
                        <a href="https://listenbrainz.org/profile/" target="_blank" class="underline hover:text-blue-300">ListenBrainz profile</a>.
                    </p>
                    <input
                        id="listenbrainz-token-input"
                        type="text"
                        placeholder="Enter your ListenBrainz user token"
                        class="w-full p-2 mb-2 bg-inherit border border-white"
                    >
                </div>

                <!-- A single, dynamic button that changes its text and function -->
                <button id="listenbrainz-button" class="w-full bg-white text-black p-2 uppercase mt-4 hover-effect">
                    Link ListenBrainz
                </button>
            </div>

            <!-- Transcoding Profiles (Available to all users) -->
            <div id="transcoding-profiles-section" class="w-full max-w-2xl border border-white p-6 dashboard-container">
                <h2 class="text-2xl mb-4">Transcoding Profiles</h2>

                <!-- Create Profile (Admin Only) -->
                <div id="create-profile-section" class="mb-6">
                    <h3 class="text-xl mb-2">Create Profile</h3>
                    <input id="profile-name" type="text" placeholder="Profile Name" class="w-full p-2 mb-2 bg-inherit border border-white">
                    <input
                        id="profile-format"
                        type="text"
                        placeholder="Format (e.g., mp3, opus)"
                        class="w-full p-2 mb-2 bg-inherit border border-white"
                    >
                    <input id="profile-bitrate" type="number" placeholder="Bitrate (kbps)" class="w-full p-2 mb-2 bg-inherit border border-white">
                    <input
                        id="profile-client-match"
                        type="text"
                        placeholder="Client Match (regex)"
                        class="w-full p-2 mb-2 bg-inherit border border-white"
                    >
                    <label class="flex items-center mb-2">
                        <input id="profile-enabled" type="checkbox" class="mr-2">
                        <span>Enabled</span>
                    </label>
                    <button id="create-profile" class="w-full bg-green-700 p-2 uppercase hover-effect">
                        Create Profile
                    </button>
                </div>

                <!-- Profiles List -->
                <div>
                    <h3 class="text-xl mb-2">Existing Profiles</h3>
                    <ul id="profiles-container" class="list-none"></ul>
                </div>
            </div>

            <!-- Logout -->
            <div class="w-full max-w-2xl border border-white p-6 dashboard-container">
                <button id="logout-button" class="w-full bg-red-500 p-2 uppercase hover-effect">Logout</button>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer w-full py-4 px-8 mt-12">
            <div class="max-w-4xl mx-auto flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <span>&copy; 2025 Dinosonic | <span id="version">Version 0.0.0</span></span>
                </div>
                <div class="flex space-x-6">
                    <a href="https://github.com/sonicdino/dinosonic" class="social-link" target="_blank">GitHub</a>
                    <!-- <a href="https://dinosonic.fuge.dev" class="social-link" target="_blank">Website</a>
                <a href="https://docs.dinosonic.fuge.dev" class="social-link" target="_blank">Documentation</a> -->
                </div>
            </div>
        </footer>

        <!-- Edit User Modal -->
        <div id="edit-user-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
            <div class="bg-black p-6 border border-white shadow-lg">
                <h2 class="text-xl font-bold mb-4">Edit User</h2>
                <label class="block">Username:
                    <input type="text" id="edit-username" class="bg-inherit border border-white p-2 w-full">
                </label>
                <label class="block mt-2">New Password:
                    <input type="password" id="edit-password" class="bg-inherit border border-white p-2 w-full">
                </label>
                <div class="mt-4">
                    <h3 class="font-semibold">Permissions</h3>
                    <div id="edit-permissions" class="grid grid-cols-2 gap-2 mt-2">
                        <!-- Checkboxes will be inserted here -->
                    </div>
                </div>
                <div class="mt-4 flex justify-between">
                    <button id="save-user" class="bg-green-500 px-4 py-2 hover-effect">Save</button>
                    <button id="close-modal" class="bg-white text-black px-4 py-2 hover-effect">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Edit Transcoding Profile Modal -->
        <div id="edit-profile-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
            <div class="bg-black p-6 border border-white shadow-lg w-full max-w-md">
                <h2 class="text-xl font-bold mb-4">Edit Transcoding Profile</h2>
                <div class="mb-4">
                    <label class="block mb-1">Profile Name:</label>
                    <input type="text" id="edit-profile-name" class="bg-inherit border border-white p-2 w-full">
                </div>
                <div class="mb-4">
                    <label class="block mb-1">Format (e.g., mp3, opus):</label>
                    <input type="text" id="edit-profile-format" class="bg-inherit border border-white p-2 w-full">
                </div>
                <div class="mb-4">
                    <label class="block mb-1">Bitrate (kbps):</label>
                    <input type="number" id="edit-profile-bitrate" class="bg-inherit border border-white p-2 w-full">
                </div>
                <div class="mb-4">
                    <label class="block mb-1">Client Match (regex):</label>
                    <input type="text" id="edit-profile-client-match" class="bg-inherit border border-white p-2 w-full">
                </div>
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="edit-profile-enabled" class="mr-2">
                        <span>Enabled</span>
                    </label>
                </div>
                <div class="mt-6 flex justify-between">
                    <button id="save-profile" class="bg-green-500 px-4 py-2 hover-effect">Save</button>
                    <button id="close-profile-modal" class="bg-white text-black px-4 py-2 hover-effect">Cancel</button>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', async function () {
                const usersContainer = document.getElementById('users-container');
                const adminControls = document.getElementById('admin-controls');
                const createUserBtn = document.getElementById('create-user');

                // Modal Elements
                const editUserModal = document.getElementById('edit-user-modal');
                const editUsernameInput = document.getElementById('edit-username');
                const editPasswordInput = document.getElementById('edit-password');
                const editPermissionsContainer = document.getElementById('edit-permissions');
                const saveUserBtn = document.getElementById('save-user');
                const closeModalBtn = document.getElementById('close-modal');

                // Transcoding Profile Modal Elements
                const editProfileModal = document.getElementById('edit-profile-modal');
                const editProfileNameInput = document.getElementById('edit-profile-name');
                const editProfileFormatInput = document.getElementById('edit-profile-format');
                const editProfileBitrateInput = document.getElementById('edit-profile-bitrate');
                const editProfileClientMatchInput = document.getElementById('edit-profile-client-match');
                const editProfileEnabledInput = document.getElementById('edit-profile-enabled');
                const saveProfileBtn = document.getElementById('save-profile');
                const closeProfileModalBtn = document.getElementById('close-profile-modal');

                let editingUser = null; // Stores current user being edited
                let editingProfileId = null; // Stores current profile being edited

                async function checkUserPermissions() {
                    const response = await fetch('/api/users');
                    const data = await response.json();
                    const currentUser = data.currentUser;

                    if (currentUser.adminRole) {
                        document.getElementById('user-management').classList.remove('hidden');
                        document.getElementById('admin-controls').classList.remove('hidden');
                        fetchUsers();
                    }
                }

                async function fetchUsers() {
                    const response = await fetch('/api/users');
                    const data = await response.json();
                    const currentUser = data.currentUser;
                    const users = data.users;

                    usersContainer.innerHTML = '';

                    users.forEach((user) => {
                        if (!currentUser.adminRole && user.username !== currentUser.username) return;

                        const userElement = document.createElement('li');
                        userElement.classList.add('border', 'p-4', 'mb-2');
                        userElement.innerHTML = `
                        <strong>${user.username}</strong>
                        ${
                            currentUser.adminRole && user.username !== currentUser.username
                                ? `<button onclick="deleteUser('${user.username}')" class="bg-red-500 p-1 ml-2 hover-effect">Delete</button>`
                                : ''
                        }
                        <button onclick="openEditModal('${user.username}')" class="bg-blue-500 p-1 ml-2 hover-effect">Edit</button>
                    `;

                        usersContainer.appendChild(userElement);
                    });

                    if (currentUser.adminRole) {
                        adminControls.classList.remove('hidden');
                    }
                }

                async function createUser() {
                    const username = document.getElementById('new-username').value;
                    const password = document.getElementById('new-password').value;

                    if (!username || !password) {
                        alert('Username and password are required');
                        return;
                    }

                    await fetch('/api/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password }),
                    });

                    // Clear inputs
                    document.getElementById('new-username').value = '';
                    document.getElementById('new-password').value = '';

                    fetchUsers();
                }

                window.deleteUser = async function (username) {
                    if (confirm(`Are you sure you want to delete user ${username}?`)) {
                        await fetch(`/api/users/${username}`, { method: 'DELETE' });
                        fetchUsers();
                    }
                };

                window.openEditModal = async function (username) {
                    const response = await fetch(`/api/users/${username}`);
                    editingUser = await response.json();

                    // Fill modal inputs
                    editUsernameInput.value = editingUser.username;
                    editPasswordInput.value = ''; // Don't pre-fill passwords

                    // Generate checkboxes for permissions
                    editPermissionsContainer.innerHTML = '';
                    const permissions = [
                        'adminRole',
                        'settingsRole',
                        'downloadRole',
                        'playlistRole',
                        'coverArtRole',
                        'jukeboxRole',
                        'streamRole',
                        'scrobblingEnabled',
                    ];

                    permissions.forEach((permission) => {
                        const isChecked = editingUser[permission] ? 'checked' : '';
                        editPermissionsContainer.innerHTML += `
                        <label class="flex items-center">
                            <input type="checkbox" id="perm-${permission}" ${isChecked} class="mr-2"> 
                            <span>${permission}</span>
                        </label>
                    `;
                    });

                    // Show modal
                    editUserModal.classList.remove('hidden');
                };

                saveUserBtn.addEventListener('click', async () => {
                    if (!editingUser) return;

                    const updatedUser = {
                        username: editUsernameInput.value,
                        password: editPasswordInput.value || undefined, // Don't send password if empty
                        permissions: {
                            uploadRole: false,
                            commentRole: false,
                            podcastRole: false,
                            shareRole: false,
                        },
                    };

                    // Permissions that can be modified by the admin
                    const editablePermissions = [
                        'adminRole',
                        'settingsRole',
                        'downloadRole',
                        'playlistRole',
                        'coverArtRole',
                        'jukeboxRole',
                        'streamRole',
                        'scrobblingEnabled',
                    ];

                    // Collect editable permissions from the form
                    editablePermissions.forEach((permission) => {
                        updatedUser.permissions[permission] = document.getElementById(`perm-${permission}`).checked;
                    });

                    await fetch(`/api/users/${editingUser.username}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updatedUser),
                    });

                    editUserModal.classList.add('hidden');
                    fetchUsers();
                });

                closeModalBtn.addEventListener('click', () => {
                    editUserModal.classList.add('hidden');
                });

                createUserBtn.addEventListener('click', createUser);

                async function checkStatus() {
                    const response = await fetch('/api/status', { credentials: 'include' });
                    const data = await response.json();

                    const lastfmText = document.getElementById('lastfm-text');
                    const lastfmButton = document.getElementById('lastfm-button');
                    const listenbrainzText = document.getElementById('listenbrainz-text');
                    const listenbrainzInputContainer = document.getElementById('listenbrainz-input-container');
                    const listenbrainzButton = document.getElementById('listenbrainz-button');
                    const listenbrainzTokenInput = document.getElementById('listenbrainz-token-input');

                    lastfmText.textContent = data.lastfm ? 'Linked' : 'Not Linked';
                    lastfmText.classList.toggle('text-green-500', data.lastfm);
                    lastfmText.classList.toggle('text-red-500', !data.lastfm);
                    listenbrainzInputContainer.classList.add('hidden');
                    listenbrainzButton.classList.remove('bg-red-500', 'bg-green-700');
                    listenbrainzButton.classList.add('bg-white', 'text-black');

                    if (data.lastFMScrobblingEnabled) {
                        lastfmButton.textContent = data.lastfm ? 'Unlink LastFM' : 'Link LastFM';
                        lastfmButton.onclick = () => {
                            if (data.lastfm && confirm('Are you sure you want to unlink your last.fm account?')) {
                                window.location.href = '/api/unlink/lastfm';
                            }

                            if (!data.lastfm) window.location.href = '/api/link/lastfm';
                        };

                        lastfmButton.disabled = false;
                        lastfmButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        lastfmButton.disabled = true;
                        lastfmButton.classList.add('opacity-50', 'cursor-not-allowed');
                        lastfmButton.onclick = () => alert('LastFM scrobbling is not enabled.');
                    }

                    if (data.listenBrainzScrobblingEnabled) {
                        if (data.listenBrainz) {
                            listenbrainzText.innerHTML = `Linked`; // as <span class="text-white font-bold">${data.listenbrainzUser}</span>`;
                            listenbrainzText.classList.add('text-green-500');
                            listenbrainzText.classList.remove('text-red-500');

                            listenbrainzButton.textContent = 'Unlink ListenBrainz';
                            // listenbrainzButton.classList.add('bg-red-500');
                            // listenbrainzButton.classList.remove('bg-white', 'text-black');
                            listenbrainzButton.onclick = () => {
                                if (confirm('Are you sure you want to unlink your ListenBrainz account?')) {
                                    unlinkListenBrainz();
                                }
                            };
                        } else {
                            listenbrainzText.textContent = 'Not Linked';
                            // listenbrainzText.classList.add('text-red-500');
                            listenbrainzText.classList.remove('text-green-500');

                            listenbrainzButton.textContent = 'Link ListenBrainz';
                            listenbrainzButton.onclick = showListenBrainzInput;
                        }

                        listenbrainzButton.disabled = false;
                        listenbrainzButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        listenbrainzButton.classList.add('opacity-50', 'cursor-not-allowed');
                        listenbrainzButton.disabled = true;
                        listenbrainzButton.onclick = () => alert('Scrobbling is not enabled in the server configuration.');
                    }
                }

                function showListenBrainzInput() {
                    // STATE: User wants to link, show the input field
                    const listenbrainzInputContainer = document.getElementById('listenbrainz-input-container');
                    const listenbrainzButton = document.getElementById('listenbrainz-button');

                    listenbrainzInputContainer.classList.remove('hidden');
                    listenbrainzButton.textContent = 'Save Token';
                    listenbrainzButton.classList.add('bg-green-700');
                    listenbrainzButton.classList.remove('bg-white', 'text-black');
                    listenbrainzButton.onclick = saveListenBrainzToken;
                }

                async function saveListenBrainzToken() {
                    const tokenInput = document.getElementById('listenbrainz-token-input');
                    const token = tokenInput.value.trim();

                    if (!token) {
                        alert('Please enter a ListenBrainz user token.');
                        return;
                    }

                    try {
                        const response = await fetch('/api/link/listenbrainz', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ token: token }),
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            alert(`Successfully linked ListenBrainz account for user: ${result.userName}`);
                            tokenInput.value = ''; // Clear input on success
                        } else {
                            alert(`Failed to link token. Error: ${result.error || 'Invalid token or server error.'}`);
                        }
                    } catch (error) {
                        alert('An error occurred while trying to save the token.');
                        console.error('Save ListenBrainz Token Error:', error);
                    } finally {
                        checkStatus(); // Always refresh the UI to show the final state
                    }
                }

                async function unlinkListenBrainz() {
                    try {
                        await fetch('/api/unlink/listenbrainz', { method: 'GET' }); // Or POST if you prefer
                    } catch (error) {
                        alert('An error occurred while trying to unlink.');
                        console.error('Unlink ListenBrainz Error:', error);
                    } finally {
                        checkStatus(); // Refresh the UI after unlinking
                    }
                }

                document.getElementById('logout-button').addEventListener('click', async () => {
                    if (confirm(`Are you sure you want to log out?`)) {
                        await fetch('/api/logout', { method: 'POST', credentials: 'include' });
                        window.location.href = '/admin/login';
                    }
                });

                document.getElementById('logout-button').addEventListener('click', async () => {
                    if (confirm(`Are you sure you want to log out?`)) {
                        await fetch('/api/logout', { method: 'POST', credentials: 'include' });
                        window.location.href = '/admin/login';
                    }
                });

                // Close modal when clicking outside of it
                editUserModal.addEventListener('click', function (event) {
                    if (event.target === editUserModal) {
                        editUserModal.classList.add('hidden');
                    }
                });

                // Transcoding Profiles Management
                async function loadTranscodingProfiles() {
                    try {
                        const response = await fetch('/api/transcoding-profiles');
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        const profilesContainer = document.getElementById('profiles-container');

                        profilesContainer.innerHTML = '';

                        if (data.profiles && data.profiles.length > 0) {
                            data.profiles.forEach((profile) => {
                                const profileElement = document.createElement('li');
                                profileElement.classList.add('border', 'p-4', 'mb-2');
                                profileElement.innerHTML = `
                                <div class="flex justify-between items-center">
                                    <div>
                                        <strong>${profile.name}</strong> - ${profile.format || 'default'} 
                                        ${profile.bitRate ? `@ ${profile.bitRate}kbps` : ''}
                                        ${profile.enabled ? '(Enabled)' : '(Disabled)'}
                                    </div>
                                    <div>
                                        <button onclick="editProfile('${profile.id}')" class="bg-blue-500 p-1 ml-2 hover-effect">Edit</button>
                                        <button onclick="deleteProfile('${profile.id}')" class="bg-red-500 p-1 ml-2 hover-effect">Delete</button>
                                    </div>
                                </div>
                                ${profile.clientMatch ? `<div class="text-sm mt-1">Client Match: ${profile.clientMatch}</div>` : ''}
                            `;
                                profilesContainer.appendChild(profileElement);
                            });
                        } else {
                            profilesContainer.innerHTML = '<li class="p-4">No transcoding profiles found</li>';
                        }
                    } catch (error) {
                        console.error('Error loading transcoding profiles:', error);
                        document.getElementById('profiles-container').innerHTML =
                            '<li class="p-4 text-red-500">Error loading profiles</li>';
                    }
                }

                async function createProfile() {
                    const name = document.getElementById('profile-name').value;
                    const format = document.getElementById('profile-format').value;
                    const bitRate = document.getElementById('profile-bitrate').value;
                    const clientMatch = document.getElementById('profile-client-match').value;
                    const enabled = document.getElementById('profile-enabled').checked;

                    if (!name) {
                        alert('Profile name is required');
                        return;
                    }

                    const profileData = {
                        name,
                        format: format || undefined,
                        bitRate: bitRate ? parseInt(bitRate) : undefined,
                        clientMatch: clientMatch || undefined,
                        enabled: enabled,
                    };

                    try {
                        const response = await fetch('/api/transcoding-profiles', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(profileData),
                        });

                        if (response.ok) {
                            // Clear inputs
                            document.getElementById('profile-name').value = '';
                            document.getElementById('profile-format').value = '';
                            document.getElementById('profile-bitrate').value = '';
                            document.getElementById('profile-client-match').value = '';
                            document.getElementById('profile-enabled').checked = false;

                            loadTranscodingProfiles();
                        } else {
                            const errorData = await response.json();
                            alert(`Error: ${errorData.error || 'Failed to create profile'}`);
                        }
                    } catch (error) {
                        console.error('Error creating profile:', error);
                        alert('Error creating profile');
                    }
                }

                window.editProfile = async function (id) {
                    try {
                        const response = await fetch(`/api/transcoding-profiles/${id}`);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();

                        if (data.profile) {
                            // Fill the modal with profile data for editing
                            editingProfileId = id;
                            editProfileNameInput.value = data.profile.name;
                            editProfileFormatInput.value = data.profile.format || '';
                            editProfileBitrateInput.value = data.profile.bitRate || '';
                            editProfileClientMatchInput.value = data.profile.clientMatch || '';
                            editProfileEnabledInput.checked = data.profile.enabled;

                            // Show modal
                            editProfileModal.classList.remove('hidden');
                        }
                    } catch (error) {
                        console.error('Error fetching profile for edit:', error);
                        alert('Error fetching profile for editing');
                    }
                };

                // Save profile from modal
                saveProfileBtn.addEventListener('click', async () => {
                    if (!editingProfileId) return;

                    const name = editProfileNameInput.value;
                    const format = editProfileFormatInput.value;
                    const bitRate = editProfileBitrateInput.value;
                    const clientMatch = editProfileClientMatchInput.value;
                    const enabled = editProfileEnabledInput.checked;

                    if (!name) {
                        alert('Profile name is required');
                        return;
                    }

                    const profileData = {
                        name,
                        format: format || undefined,
                        bitRate: bitRate ? parseInt(bitRate) : undefined,
                        clientMatch: clientMatch || undefined,
                        enabled: enabled,
                    };

                    try {
                        const response = await fetch(`/api/transcoding-profiles/${editingProfileId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(profileData),
                        });

                        if (response.ok) {
                            // Clear inputs
                            editProfileNameInput.value = '';
                            editProfileFormatInput.value = '';
                            editProfileBitrateInput.value = '';
                            editProfileClientMatchInput.value = '';
                            editProfileEnabledInput.checked = false;

                            editingProfileId = null;

                            // Hide modal
                            editProfileModal.classList.add('hidden');

                            loadTranscodingProfiles();
                        } else {
                            const errorData = await response.json();
                            alert(`Error: ${errorData.error || 'Failed to update profile'}`);
                        }
                    } catch (error) {
                        console.error('Error updating profile:', error);
                        alert('Error updating profile');
                    }
                });

                // Close profile modal
                closeProfileModalBtn.addEventListener('click', () => {
                    editProfileModal.classList.add('hidden');
                    editingProfileId = null;
                });

                // Close modal when clicking outside of it
                editProfileModal.addEventListener('click', function (event) {
                    if (event.target === editProfileModal) {
                        editProfileModal.classList.add('hidden');
                        editingProfileId = null;
                    }
                });

                window.deleteProfile = async function (id) {
                    if (confirm('Are you sure you want to delete this transcoding profile?')) {
                        try {
                            const response = await fetch(`/api/transcoding-profiles/${id}`, {
                                method: 'DELETE',
                            });

                            if (response.ok) {
                                loadTranscodingProfiles();
                            } else {
                                const errorData = await response.json();
                                alert(`Error: ${errorData.error || 'Failed to delete profile'}`);
                            }
                        } catch (error) {
                            console.error('Error deleting profile:', error);
                            alert('Error deleting profile');
                        }
                    }
                };

                // Add event listeners for transcoding profiles
                document.getElementById('create-profile').addEventListener('click', createProfile);

                // API Keys Management
                async function loadApiKeys() {
                    try {
                        const response = await fetch('/api/api-keys');
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        const apiKeysContainer = document.getElementById('api-keys-container');

                        apiKeysContainer.innerHTML = '';

                        if (data.success && data.keys && data.keys.length > 0) {
                            data.keys.forEach((key) => {
                                const keyElement = document.createElement('li');
                                keyElement.classList.add('border', 'p-4', 'mb-2');
                                const lastUsed = key.lastUsed ? new Date(key.lastUsed).toLocaleString() : 'Never';
                                const created = new Date(key.created).toLocaleString();
                                keyElement.innerHTML = `
                                <div class="flex justify-between items-center">
                                    <div class="flex-1">
                                        <strong>${key.name}</strong>
                                        <div class="text-sm text-gray-400 font-mono break-all">Key: ${key.key}</div>
                                        <div class="text-sm text-gray-400">Created: ${created}</div>
                                        <div class="text-sm text-gray-400">Last Used: ${lastUsed}</div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="copyApiKey('${key.key}')" class="bg-blue-600 p-1 hover-effect">Copy</button>
                                        <button onclick="deleteApiKey('${key.keyPreview}')" class="bg-red-500 p-1 hover-effect">Revoke</button>
                                    </div>
                                </div>
                            `;
                                apiKeysContainer.appendChild(keyElement);
                            });
                        } else {
                            apiKeysContainer.innerHTML =
                                '<li class="p-4 text-gray-400">No API keys found. Create one to get started!</li>';
                        }
                    } catch (error) {
                        console.error('Error loading API keys:', error);
                        document.getElementById('api-keys-container').innerHTML =
                            '<li class="p-4 text-red-500">Error loading API keys</li>';
                    }
                }

                async function createApiKey() {
                    const name = document.getElementById('api-key-name').value.trim() || 'Unnamed API Key';

                    try {
                        const response = await fetch('/api/api-keys', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name }),
                        });

                        if (response.ok) {
                            const data = await response.json();

                            // Show the API key in a modal
                            document.getElementById('new-api-key-value').textContent = data.apiKey;
                            document.getElementById('new-api-key-modal').classList.remove('hidden');

                            // Clear input
                            document.getElementById('api-key-name').value = '';

                            loadApiKeys();
                        } else {
                            const errorData = await response.json();
                            alert(`Error: ${errorData.error || 'Failed to create API key'}`);
                        }
                    } catch (error) {
                        console.error('Error creating API key:', error);
                        alert('Error creating API key');
                    }
                }

                window.copyApiKey = function (apiKey) {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(apiKey).then(() => {
                            alert('API key copied to clipboard!');
                        }).catch((err) => {
                            console.error('Failed to copy:', err);
                            fallbackCopy(apiKey);
                        });
                    } else {
                        fallbackCopy(apiKey);
                    }
                };

                function fallbackCopy(text) {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        alert('API key copied to clipboard!');
                    } catch (err) {
                        console.error('Fallback copy failed:', err);
                        prompt('Copy this API key:', text);
                    }
                    document.body.removeChild(textarea);
                }

                window.deleteApiKey = async function (keyPreview) {
                    if (confirm('Are you sure you want to revoke this API key? This cannot be undone.')) {
                        try {
                            const response = await fetch(`/api/api-keys/${encodeURIComponent(keyPreview)}`, {
                                method: 'DELETE',
                            });

                            if (response.ok) {
                                loadApiKeys();
                            } else {
                                const errorData = await response.json();
                                alert(`Error: ${errorData.error || 'Failed to revoke API key'}`);
                            }
                        } catch (error) {
                            console.error('Error revoking API key:', error);
                            alert('Error revoking API key');
                        }
                    }
                };

                document.getElementById('create-api-key').addEventListener('click', createApiKey);

                document.getElementById('copy-api-key').addEventListener('click', () => {
                    const apiKey = document.getElementById('new-api-key-value').textContent;
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(apiKey).then(() => {
                            alert('API key copied to clipboard!');
                        }).catch((err) => {
                            console.error('Failed to copy:', err);
                            fallbackCopy(apiKey);
                        });
                    } else {
                        fallbackCopy(apiKey);
                    }
                });

                document.getElementById('close-api-key-modal').addEventListener('click', () => {
                    document.getElementById('new-api-key-modal').classList.add('hidden');
                });

                // Dino Music Login Button
                document.getElementById('dino-music-login').addEventListener('click', async () => {
                    try {
                        // Get current user info
                        const userResponse = await fetch('/api/users');
                        const userData = await userResponse.json();
                        const username = userData.currentUser.username;

                        // Get server URL from current location
                        const serverUrl = window.location.origin;
                        const serverName = 'Dinosonic';

                        // Ask user which authentication method they want to use
                        const authMethod = confirm(
                            'Choose authentication method:\n\n' +
                                'OK = Use API Key (Recommended - more secure)\n' +
                                'Cancel = Use Password (Traditional method)',
                        );

                        let deeplink;

                        if (authMethod) {
                            // API Key method
                            const useExisting = confirm(
                                'Do you have an existing API key?\n\n' +
                                    'OK = Use existing API key\n' +
                                    'Cancel = Create new API key for Dino Music',
                            );

                            let apiKey;

                            if (useExisting) {
                                // Ask user to paste their API key
                                apiKey = prompt('Paste your API key:');
                                if (!apiKey) {
                                    alert('API key is required');
                                    return;
                                }
                            } else {
                                // Create a new API key for Dino Music
                                try {
                                    const response = await fetch('/api/api-keys', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ name: 'Dino Music' }),
                                    });

                                    if (!response.ok) {
                                        throw new Error('Failed to create API key');
                                    }

                                    const data = await response.json();
                                    apiKey = data.apiKey;

                                    // Reload API keys list to show the new key
                                    loadApiKeys();

                                    alert('New API key created for Dino Music!\n\nKey: ' + apiKey.substring(0, 20) + '...');
                                } catch (error) {
                                    console.error('Error creating API key:', error);
                                    alert('Failed to create API key. Please try again.');
                                    return;
                                }
                            }

                            // Build deeplink with API key
                            deeplink = `dino://add-server?url=${encodeURIComponent(serverUrl)}&name=${
                                encodeURIComponent(serverName)
                            }&apiKey=${encodeURIComponent(apiKey)}`;
                        } else {
                            // Password method (traditional token/salt)
                            const password = prompt('Enter your password to generate a login link for Dino Music:');
                            if (!password) {
                                return;
                            }

                            // Generate a temporary salt and token for the deeplink
                            const salt = Math.random().toString(36).substring(2, 15);

                            // Proper MD5 implementation for browser
                            function md5(string) {
                                function md5RotateLeft(lValue, iShiftBits) {
                                    return (lValue << iShiftBits) | (lValue >>> (32 - iShiftBits));
                                }

                                function md5AddUnsigned(lX, lY) {
                                    const lX8 = lX & 0x80000000;
                                    const lY8 = lY & 0x80000000;
                                    const lX4 = lX & 0x40000000;
                                    const lY4 = lY & 0x40000000;
                                    const lResult = (lX & 0x3FFFFFFF) + (lY & 0x3FFFFFFF);
                                    if (lX4 & lY4) {
                                        return (lResult ^ 0x80000000 ^ lX8 ^ lY8);
                                    }
                                    if (lX4 | lY4) {
                                        if (lResult & 0x40000000) {
                                            return (lResult ^ 0xC0000000 ^ lX8 ^ lY8);
                                        } else {
                                            return (lResult ^ 0x40000000 ^ lX8 ^ lY8);
                                        }
                                    } else {
                                        return (lResult ^ lX8 ^ lY8);
                                    }
                                }

                                function md5F(x, y, z) {
                                    return (x & y) | ((~x) & z);
                                }
                                function md5G(x, y, z) {
                                    return (x & z) | (y & (~z));
                                }
                                function md5H(x, y, z) {
                                    return (x ^ y ^ z);
                                }
                                function md5I(x, y, z) {
                                    return (y ^ (x | (~z)));
                                }

                                function md5FF(a, b, c, d, x, s, ac) {
                                    a = md5AddUnsigned(a, md5AddUnsigned(md5AddUnsigned(md5F(b, c, d), x), ac));
                                    return md5AddUnsigned(md5RotateLeft(a, s), b);
                                }

                                function md5GG(a, b, c, d, x, s, ac) {
                                    a = md5AddUnsigned(a, md5AddUnsigned(md5AddUnsigned(md5G(b, c, d), x), ac));
                                    return md5AddUnsigned(md5RotateLeft(a, s), b);
                                }

                                function md5HH(a, b, c, d, x, s, ac) {
                                    a = md5AddUnsigned(a, md5AddUnsigned(md5AddUnsigned(md5H(b, c, d), x), ac));
                                    return md5AddUnsigned(md5RotateLeft(a, s), b);
                                }

                                function md5II(a, b, c, d, x, s, ac) {
                                    a = md5AddUnsigned(a, md5AddUnsigned(md5AddUnsigned(md5I(b, c, d), x), ac));
                                    return md5AddUnsigned(md5RotateLeft(a, s), b);
                                }

                                function md5ConvertToWordArray(string) {
                                    let lWordCount;
                                    const lMessageLength = string.length;
                                    const lNumberOfWords_temp1 = lMessageLength + 8;
                                    const lNumberOfWords_temp2 = (lNumberOfWords_temp1 - (lNumberOfWords_temp1 % 64)) / 64;
                                    const lNumberOfWords = (lNumberOfWords_temp2 + 1) * 16;
                                    const lWordArray = Array(lNumberOfWords - 1);
                                    let lBytePosition = 0;
                                    let lByteCount = 0;
                                    while (lByteCount < lMessageLength) {
                                        lWordCount = (lByteCount - (lByteCount % 4)) / 4;
                                        lBytePosition = (lByteCount % 4) * 8;
                                        lWordArray[lWordCount] = lWordArray[lWordCount] |
                                            (string.charCodeAt(lByteCount) << lBytePosition);
                                        lByteCount++;
                                    }
                                    lWordCount = (lByteCount - (lByteCount % 4)) / 4;
                                    lBytePosition = (lByteCount % 4) * 8;
                                    lWordArray[lWordCount] = lWordArray[lWordCount] | (0x80 << lBytePosition);
                                    lWordArray[lNumberOfWords - 2] = lMessageLength << 3;
                                    lWordArray[lNumberOfWords - 1] = lMessageLength >>> 29;
                                    return lWordArray;
                                }

                                function md5WordToHex(lValue) {
                                    let WordToHexValue = '', WordToHexValue_temp = '', lByte, lCount;
                                    for (lCount = 0; lCount <= 3; lCount++) {
                                        lByte = (lValue >>> (lCount * 8)) & 255;
                                        WordToHexValue_temp = '0' + lByte.toString(16);
                                        WordToHexValue = WordToHexValue +
                                            WordToHexValue_temp.substr(WordToHexValue_temp.length - 2, 2);
                                    }
                                    return WordToHexValue;
                                }

                                function md5Utf8Encode(string) {
                                    string = string.replace(/\r\n/g, '\n');
                                    let utftext = '';
                                    for (let n = 0; n < string.length; n++) {
                                        const c = string.charCodeAt(n);
                                        if (c < 128) {
                                            utftext += String.fromCharCode(c);
                                        } else if ((c > 127) && (c < 2048)) {
                                            utftext += String.fromCharCode((c >> 6) | 192);
                                            utftext += String.fromCharCode((c & 63) | 128);
                                        } else {
                                            utftext += String.fromCharCode((c >> 12) | 224);
                                            utftext += String.fromCharCode(((c >> 6) & 63) | 128);
                                            utftext += String.fromCharCode((c & 63) | 128);
                                        }
                                    }
                                    return utftext;
                                }

                                let x = [];
                                let k, AA, BB, CC, DD, a, b, c, d;
                                const S11 = 7, S12 = 12, S13 = 17, S14 = 22;
                                const S21 = 5, S22 = 9, S23 = 14, S24 = 20;
                                const S31 = 4, S32 = 11, S33 = 16, S34 = 23;
                                const S41 = 6, S42 = 10, S43 = 15, S44 = 21;

                                string = md5Utf8Encode(string);
                                x = md5ConvertToWordArray(string);
                                a = 0x67452301;
                                b = 0xEFCDAB89;
                                c = 0x98BADCFE;
                                d = 0x10325476;

                                for (k = 0; k < x.length; k += 16) {
                                    AA = a;
                                    BB = b;
                                    CC = c;
                                    DD = d;
                                    a = md5FF(a, b, c, d, x[k + 0], S11, 0xD76AA478);
                                    d = md5FF(d, a, b, c, x[k + 1], S12, 0xE8C7B756);
                                    c = md5FF(c, d, a, b, x[k + 2], S13, 0x242070DB);
                                    b = md5FF(b, c, d, a, x[k + 3], S14, 0xC1BDCEEE);
                                    a = md5FF(a, b, c, d, x[k + 4], S11, 0xF57C0FAF);
                                    d = md5FF(d, a, b, c, x[k + 5], S12, 0x4787C62A);
                                    c = md5FF(c, d, a, b, x[k + 6], S13, 0xA8304613);
                                    b = md5FF(b, c, d, a, x[k + 7], S14, 0xFD469501);
                                    a = md5FF(a, b, c, d, x[k + 8], S11, 0x698098D8);
                                    d = md5FF(d, a, b, c, x[k + 9], S12, 0x8B44F7AF);
                                    c = md5FF(c, d, a, b, x[k + 10], S13, 0xFFFF5BB1);
                                    b = md5FF(b, c, d, a, x[k + 11], S14, 0x895CD7BE);
                                    a = md5FF(a, b, c, d, x[k + 12], S11, 0x6B901122);
                                    d = md5FF(d, a, b, c, x[k + 13], S12, 0xFD987193);
                                    c = md5FF(c, d, a, b, x[k + 14], S13, 0xA679438E);
                                    b = md5FF(b, c, d, a, x[k + 15], S14, 0x49B40821);
                                    a = md5GG(a, b, c, d, x[k + 1], S21, 0xF61E2562);
                                    d = md5GG(d, a, b, c, x[k + 6], S22, 0xC040B340);
                                    c = md5GG(c, d, a, b, x[k + 11], S23, 0x265E5A51);
                                    b = md5GG(b, c, d, a, x[k + 0], S24, 0xE9B6C7AA);
                                    a = md5GG(a, b, c, d, x[k + 5], S21, 0xD62F105D);
                                    d = md5GG(d, a, b, c, x[k + 10], S22, 0x2441453);
                                    c = md5GG(c, d, a, b, x[k + 15], S23, 0xD8A1E681);
                                    b = md5GG(b, c, d, a, x[k + 4], S24, 0xE7D3FBC8);
                                    a = md5GG(a, b, c, d, x[k + 9], S21, 0x21E1CDE6);
                                    d = md5GG(d, a, b, c, x[k + 14], S22, 0xC33707D6);
                                    c = md5GG(c, d, a, b, x[k + 3], S23, 0xF4D50D87);
                                    b = md5GG(b, c, d, a, x[k + 8], S24, 0x455A14ED);
                                    a = md5GG(a, b, c, d, x[k + 13], S21, 0xA9E3E905);
                                    d = md5GG(d, a, b, c, x[k + 2], S22, 0xFCEFA3F8);
                                    c = md5GG(c, d, a, b, x[k + 7], S23, 0x676F02D9);
                                    b = md5GG(b, c, d, a, x[k + 12], S24, 0x8D2A4C8A);
                                    a = md5HH(a, b, c, d, x[k + 5], S31, 0xFFFA3942);
                                    d = md5HH(d, a, b, c, x[k + 8], S32, 0x8771F681);
                                    c = md5HH(c, d, a, b, x[k + 11], S33, 0x6D9D6122);
                                    b = md5HH(b, c, d, a, x[k + 14], S34, 0xFDE5380C);
                                    a = md5HH(a, b, c, d, x[k + 1], S31, 0xA4BEEA44);
                                    d = md5HH(d, a, b, c, x[k + 4], S32, 0x4BDECFA9);
                                    c = md5HH(c, d, a, b, x[k + 7], S33, 0xF6BB4B60);
                                    b = md5HH(b, c, d, a, x[k + 10], S34, 0xBEBFBC70);
                                    a = md5HH(a, b, c, d, x[k + 13], S31, 0x289B7EC6);
                                    d = md5HH(d, a, b, c, x[k + 0], S32, 0xEAA127FA);
                                    c = md5HH(c, d, a, b, x[k + 3], S33, 0xD4EF3085);
                                    b = md5HH(b, c, d, a, x[k + 6], S34, 0x4881D05);
                                    a = md5HH(a, b, c, d, x[k + 9], S31, 0xD9D4D039);
                                    d = md5HH(d, a, b, c, x[k + 12], S32, 0xE6DB99E5);
                                    c = md5HH(c, d, a, b, x[k + 15], S33, 0x1FA27CF8);
                                    b = md5HH(b, c, d, a, x[k + 2], S34, 0xC4AC5665);
                                    a = md5II(a, b, c, d, x[k + 0], S41, 0xF4292244);
                                    d = md5II(d, a, b, c, x[k + 7], S42, 0x432AFF97);
                                    c = md5II(c, d, a, b, x[k + 14], S43, 0xAB9423A7);
                                    b = md5II(b, c, d, a, x[k + 5], S44, 0xFC93A039);
                                    a = md5II(a, b, c, d, x[k + 12], S41, 0x655B59C3);
                                    d = md5II(d, a, b, c, x[k + 3], S42, 0x8F0CCC92);
                                    c = md5II(c, d, a, b, x[k + 10], S43, 0xFFEFF47D);
                                    b = md5II(b, c, d, a, x[k + 1], S44, 0x85845DD1);
                                    a = md5II(a, b, c, d, x[k + 8], S41, 0x6FA87E4F);
                                    d = md5II(d, a, b, c, x[k + 15], S42, 0xFE2CE6E0);
                                    c = md5II(c, d, a, b, x[k + 6], S43, 0xA3014314);
                                    b = md5II(b, c, d, a, x[k + 13], S44, 0x4E0811A1);
                                    a = md5II(a, b, c, d, x[k + 4], S41, 0xF7537E82);
                                    d = md5II(d, a, b, c, x[k + 11], S42, 0xBD3AF235);
                                    c = md5II(c, d, a, b, x[k + 2], S43, 0x2AD7D2BB);
                                    b = md5II(b, c, d, a, x[k + 9], S44, 0xEB86D391);
                                    a = md5AddUnsigned(a, AA);
                                    b = md5AddUnsigned(b, BB);
                                    c = md5AddUnsigned(c, CC);
                                    d = md5AddUnsigned(d, DD);
                                }

                                return (md5WordToHex(a) + md5WordToHex(b) + md5WordToHex(c) + md5WordToHex(d)).toLowerCase();
                            }

                            const token = md5(password + salt);
                            deeplink = `dino://add-server?url=${encodeURIComponent(serverUrl)}&name=${
                                encodeURIComponent(serverName)
                            }&user=${encodeURIComponent(username)}&token=${token}&salt=${salt}`;
                        }

                        try {
                            await navigator.clipboard.writeText(deeplink);
                            alert(
                                "Deeplink URL copied to clipboard! If Dino Music doesn't open automatically, paste it in your browser.",
                            );
                        } catch (err) {
                            console.error('Failed to copy deeplink to clipboard:', err);
                            alert('Deeplink URL: ' + deeplink + '\n\nCopy this URL and paste it in your browser.');
                        }

                        window.location.href = deeplink;
                    } catch (error) {
                        console.error('Error generating Dino Music login:', error);
                        alert('Error generating login link');
                    }
                });

                checkUserPermissions();
                checkStatus();
                loadApiKeys();

                // Load transcoding profiles for all users
                fetch('/api/users')
                    .then((response) => response.json())
                    .then((data) => {
                        const currentUser = data.currentUser;
                        document.getElementById('transcoding-profiles-section').classList.remove('hidden');
                        loadTranscodingProfiles();
                    })
                    .catch((error) => console.error('Error checking user permissions:', error));
            });
        </script>
    </body>
</html>
